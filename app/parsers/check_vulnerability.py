import re
import glob
from bs4 import BeautifulSoup
from config import ROOT_PATH
from constants import SQL_VULNERABILITY_CHECK_TEXT


class CheckVulnerabilityParser:
    def __init__(self, crawled_site, storage_adapter):
        self.crawled_site = crawled_site
        self.storage_adapter = storage_adapter

    def check(self):

        payloads = {}
        for file_path in glob.glob('%s/crawler_outputs/%s-*-check-vulnerability.html'
                                   % (ROOT_PATH, self.crawled_site)):
            content = self.storage_adapter.get(file_path)
            payloads[file_path.replace(ROOT_PATH, '')] = content

        vulnerable_pages = []
        for key, value in payloads.items():
            soup = BeautifulSoup(value, 'html.parser')
            if soup.findAll(text=re.compile(SQL_VULNERABILITY_CHECK_TEXT)):
                vulnerable_pages.append(key.strip(ROOT_PATH))

        return vulnerable_pages
