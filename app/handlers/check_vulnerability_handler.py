
import json
import scrapydo
from app.handlers.base_handler import BaseHandler
from app.parsers.check_vulnerability import CheckVulnerabilityParser
from constants import USER_AGENT_KEY, CRAWLER_PROCESS_USER_AGENT, ITEM_PIPELINES_KEY, \
    CRAWLER_PIPELINE

scrapydo.setup()


class CheckVulnerabilityHandler(BaseHandler):

    def initialize(self, spider, injector, crawled_site):
        self.spider = spider
        self.injector = injector
        self.crawled_site = crawled_site

    def get(self):
        scrapydo.run_spider(self.spider, crawl_reason='check-vulnerability', injector=self.injector,
                            settings={
                                USER_AGENT_KEY: CRAWLER_PROCESS_USER_AGENT,
                                ITEM_PIPELINES_KEY: CRAWLER_PIPELINE
                            })

        parser = CheckVulnerabilityParser(self.crawled_site)
        vulnerable_pages = parser.check()

        self.write({'vulnerable': json.dumps(vulnerable_pages)})

    def post(self):
        pass
